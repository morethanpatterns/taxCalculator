<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ghana Tax Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --panel-strong: #ffffff;
      --accent: #0f172a;
      --accent-2: #3b82f6;
      --text: #0f172a;
      --muted: #64748b;
      --grid: #e2e8f0;
      --hover: #f1f5f9;
      --shadow: rgba(0, 0, 0, 0.08);
      --shadow-lg: rgba(0, 0, 0, 0.12);
    }

    [data-theme="dark"] {
      --bg: #000000;
      --panel: #1a1a1a;
      --panel-strong: #262626;
      --accent: #ffffff;
      --accent-2: #60a5fa;
      --text: #ffffff;
      --muted: #e5e7eb;
      --grid: #525252;
      --hover: #2a2a2a;
      --shadow: rgba(0, 0, 0, 0.8);
      --shadow-lg: rgba(0, 0, 0, 0.9);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px 16px 32px;
      display: flex;
      justify-content: center;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .shell {
      width: min(1400px, 100%);
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    header {
      display: flex;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
    }

    .badge {
      background: var(--accent-2);
      color: white;
      border-radius: 8px;
      padding: 6px 12px;
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.3px;
    }

    h1 {
      margin: 0;
      font-size: clamp(22px, 4vw, 28px);
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--panel);
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--grid);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .control-group label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }

    .control-group select {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .control-group select:hover {
      background: var(--hover);
    }

    .theme-toggle {
      background: var(--panel);
      border: 1px solid var(--grid);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      transition: all 0.2s;
      box-shadow: 0 2px 8px var(--shadow);
    }

    .theme-toggle:hover {
      background: var(--hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--shadow-lg);
    }

    .theme-toggle svg {
      width: 18px;
      height: 18px;
    }

    .panels {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .card {
      background: var(--panel);
      border: 2px solid var(--grid);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px var(--shadow);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 8px 30px var(--shadow-lg);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.3px;
    }

    .export-buttons {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--grid);
      background: var(--panel);
      color: var(--text);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 6px var(--shadow);
    }

    .btn:hover {
      background: var(--hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px var(--shadow-lg);
    }

    .btn-primary {
      background: var(--accent-2);
      color: white;
      border-color: var(--accent-2);
    }

    .btn-primary:hover {
      background: #2563eb;
      border-color: #2563eb;
    }

    .btn-icon {
      width: 14px;
      height: 14px;
    }

    .mode {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .pill {
      padding: 14px;
      border-radius: 12px;
      border: 2px solid var(--grid);
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--panel);
    }

    .pill:hover {
      border-color: var(--accent-2);
      background: var(--panel);
    }

    .pill input {
      accent-color: var(--accent-2);
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .pill.active {
      border-color: var(--accent-2);
      background: rgba(59, 130, 246, 0.1);
    }

    [data-theme="dark"] .pill {
      background: var(--panel-strong);
    }

    [data-theme="dark"] .pill.active {
      background: rgba(96, 165, 250, 0.2);
      border-color: var(--accent-2);
    }

    .pill strong {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--grid);
      color: var(--text);
    }

    th {
      font-weight: 700;
      color: var(--accent);
      font-size: 13px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover {
      background: var(--hover);
    }

    [data-theme="dark"] tr:hover {
      background: var(--panel-strong);
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 2px solid var(--grid);
      background: var(--hover);
      color: var(--text);
      font-size: 14px;
      transition: all 0.2s;
      font-family: inherit;
    }

    [data-theme="dark"] input[type="text"],
    [data-theme="dark"] input[type="number"] {
      background: var(--panel-strong);
      border-color: var(--grid);
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent-2);
      background: var(--panel);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    [data-theme="dark"] input[type="text"]:focus,
    [data-theme="dark"] input[type="number"]:focus {
      background: var(--panel-strong);
      border-color: var(--accent-2);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.4);
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .add-row {
      margin-top: 16px;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid var(--grid);
      color: var(--accent-2);
      background: var(--panel);
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
      box-shadow: 0 2px 6px var(--shadow);
    }

    .add-row:hover {
      background: var(--hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px var(--shadow-lg);
    }

    .remove {
      cursor: pointer;
      color: #ef4444;
      font-weight: 700;
      border: none;
      background: none;
      padding: 4px 8px;
      font-size: 20px;
      line-height: 1;
      transition: all 0.2s;
      border-radius: 4px;
    }

    .remove:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .stat {
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--grid);
      background: var(--hover);
      position: relative;
      transition: all 0.2s;
    }

    [data-theme="dark"] .stat {
      background: var(--panel-strong);
      border-color: var(--grid);
    }

    .stat:hover {
      border-color: var(--accent-2);
      box-shadow: 0 4px 12px var(--shadow);
      background: var(--panel);
    }

    [data-theme="dark"] .stat:hover {
      background: var(--panel-strong);
      border-color: var(--accent-2);
      box-shadow: 0 4px 16px rgba(96, 165, 250, 0.3);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .stat h3 {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.3px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .copy-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      opacity: 0;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }

    .stat:hover .copy-btn {
      opacity: 1;
    }

    .copy-btn:hover {
      color: var(--accent-2);
      background: var(--panel);
    }

    [data-theme="dark"] .copy-btn:hover {
      color: var(--accent-2);
      background: var(--panel-strong);
    }

    .copy-btn svg {
      width: 14px;
      height: 14px;
    }

    .stat .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.5px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] .stat .value {
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      color: #ffffff;
    }

    [data-theme="dark"] .stat h3 {
      color: #e5e7eb;
    }

    [data-theme="dark"] .note {
      color: #d1d5db;
    }

    .note {
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.5;
    }

    .quick-card {
      display: grid;
      gap: 16px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-2);
      color: white;
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 600;
      font-size: 12px;
      width: fit-content;
    }

    .divider {
      height: 1px;
      background: var(--grid);
      margin: 12px 0;
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      font-size: 14px;
      padding: 4px 0;
    }

    .total-line strong {
      font-size: 16px;
      font-weight: 700;
    }

    .history-panel {
      margin-top: 24px;
    }

    .history-list {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 12px;
    }

    .history-item {
      background: var(--hover);
      border: 1px solid var(--grid);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .history-item:hover {
      border-color: var(--accent-2);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .history-item-time {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
    }

    .history-item-total {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .history-item-details {
      font-size: 12px;
      color: var(--muted);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
    }

    .empty-history {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 14px;
    }

    @media (max-width: 1024px) {
      .panels {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      .header-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .controls {
        width: 100%;
      }

      .control-group {
        flex: 1;
      }

      .export-buttons {
        flex-wrap: wrap;
      }

      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="header-bar">
      <header>
        <h1>Tax Calculator</h1>
      </header>
      <div class="controls">
        <div class="control-group">
          <label>Decimals:</label>
          <select id="decimalPlaces">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>
        <button class="theme-toggle" id="themeToggle">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
          <span id="themeLabel">Dark</span>
        </button>
      </div>
    </div>

    <div class="panels">
      <section class="card card-strong">
        <div class="card-header">
          <div class="card-title">Tax Calculator</div>
          <div class="export-buttons">
            <button class="btn btn-primary" id="exportScreenshot">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                </path>
              </svg>
              Screenshot
            </button>
            <button class="btn btn-primary" id="exportPDF">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                </path>
              </svg>
              PDF
            </button>
            <button class="btn btn-primary" id="exportCSV">
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                </path>
              </svg>
              CSV
            </button>
          </div>
        </div>

        <div class="mode">
          <label class="pill active">
            <input type="radio" name="mode" value="exclusive" checked>
            <div>
              <div><strong>Tax-exclusive prices</strong></div>
              <div class="note">Enter prices without levies; I add everything for you.</div>
            </div>
          </label>
          <label class="pill">
            <input type="radio" name="mode" value="inclusive">
            <div>
              <div><strong>Tax-inclusive prices</strong></div>
              <div class="note">Feed me final prices; I reverse engineer the tax stack.</div>
            </div>
          </label>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width: 30%;">Item</th>
              <th style="width: 25%;">Price <span id="priceLabel">(excl. tax)</span></th>
              <th style="width: 20%;">Qty</th>
              <th style="width: 20%;">Line Total</th>
              <th style="width: 5%;"></th>
            </tr>
          </thead>
          <tbody id="items"></tbody>
        </table>
        <button class="add-row" id="addRow">+ Add item</button>

        <div class="grid">
          <div class="stat">
            <div class="stat-header">
              <h3>Base total</h3>
              <button class="copy-btn" data-copy="baseTotal" title="Copy">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                  </path>
                </svg>
              </button>
            </div>
            <div class="value" id="baseTotal">GHS 0.00</div>
            <div class="note">Sum of items before any levies or VAT.</div>
          </div>
          <div class="stat">
            <div class="stat-header">
              <h3>GETFund (2.5%)</h3>
              <button class="copy-btn" data-copy="getfund" title="Copy">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                  </path>
                </svg>
              </button>
            </div>
            <div class="value" id="getfund">GHS 0.00</div>
            <div class="note">Education Trust Fund levy</div>
          </div>
          <div class="stat">
            <div class="stat-header">
              <h3>NHIL (2.5%)</h3>
              <button class="copy-btn" data-copy="nhil" title="Copy">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                  </path>
                </svg>
              </button>
            </div>
            <div class="value" id="nhil">GHS 0.00</div>
            <div class="note">National Health Insurance Levy</div>
          </div>
          <div class="stat">
            <div class="stat-header">
              <h3>Covid-19 (1%)</h3>
              <button class="copy-btn" data-copy="covid" title="Copy">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                  </path>
                </svg>
              </button>
            </div>
            <div class="value" id="covid">GHS 0.00</div>
            <div class="note">Covid-19 Health Recovery Levy</div>
          </div>
          <div class="stat">
            <div class="stat-header">
              <h3>Total Levies</h3>
              <button class="copy-btn" data-copy="levyTotal" title="Copy">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                  </path>
                </svg>
              </button>
            </div>
            <div class="value" id="levyTotal">GHS 0.00</div>
            <div class="note">Sum of GETFund + NHIL + Covid-19</div>
          </div>
          <div class="stat">
            <div class="stat-header">
              <h3>Subtotal after levies</h3>
              <button class="copy-btn" data-copy="subTotal" title="Copy">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                  </path>
                </svg>
              </button>
            </div>
            <div class="value" id="subTotal">GHS 0.00</div>
          </div>
          <div class="stat">
            <div class="stat-header">
              <h3>VAT (15%)</h3>
              <button class="copy-btn" data-copy="vat" title="Copy">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                  </path>
                </svg>
              </button>
            </div>
            <div class="value" id="vat">GHS 0.00</div>
          </div>
          <div class="stat">
            <div class="stat-header">
              <h3>Total taxes</h3>
              <button class="copy-btn" data-copy="allTaxes" title="Copy">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                  </path>
                </svg>
              </button>
            </div>
            <div class="value" id="allTaxes">GHS 0.00</div>
            <div class="note">Sum of VAT + all levies.</div>
          </div>
          <div class="stat">
            <div class="stat-header">
              <h3>Final amount</h3>
              <button class="copy-btn" data-copy="finalTotal" title="Copy">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                  </path>
                </svg>
              </button>
            </div>
            <div class="value" id="finalTotal">GHS 0.00</div>
            <div class="note" id="modeNote">Forward calculation from tax-exclusive prices.</div>
          </div>
        </div>
      </section>

      <aside class="card quick-card">
        <div class="tag">Quick reverse</div>
        <div class="note">Have only the grand total with taxes? Drop it here and I'll unstack the math instantly.</div>
        <label>
          <div class="note">Final total (tax-inclusive)</div>
          <input type="number" id="quickFinal" placeholder="e.g. 1000" min="0" step="0.01">
        </label>
        <div class="divider"></div>
        <div>
          <div class="total-line"><span>Implied base</span><strong id="quickBase">GHS 0.00</strong></div>
          <div class="total-line"><span>GETFund 2.5%</span><span id="quickGetfund">GHS 0.00</span></div>
          <div class="total-line"><span>NHIL 2.5%</span><span id="quickNhil">GHS 0.00</span></div>
          <div class="total-line"><span>Covid-19 1%</span><span id="quickCovid">GHS 0.00</span></div>
          <div class="total-line"><span>Subtotal after levies</span><span id="quickSub">GHS 0.00</span></div>
          <div class="total-line"><span>VAT 15%</span><span id="quickVat">GHS 0.00</span></div>
          <div class="total-line"><span>Total taxes</span><span id="quickAllTaxes">GHS 0.00</span></div>
          <div class="divider"></div>
          <div class="total-line"><span>Recomputed total</span><strong id="quickTotal">GHS 0.00</strong></div>
        </div>
      </aside>
    </div>

    <div class="card history-panel">
      <div class="card-header">
        <div class="card-title">Calculation History</div>
        <button class="btn" id="clearHistory">Clear</button>
      </div>
      <div class="history-list" id="historyList">
        <div class="empty-history">No calculations yet. Your recent calculations will appear here.</div>
      </div>
    </div>
  </div>

  <script>
    const itemsBody = document.getElementById('items');
    const addRowBtn = document.getElementById('addRow');
    const priceLabel = document.getElementById('priceLabel');
    const modeNote = document.getElementById('modeNote');
    const quickFinal = document.getElementById('quickFinal');
    const decimalPlacesSelect = document.getElementById('decimalPlaces');
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const exportScreenshot = document.getElementById('exportScreenshot');
    const exportPDF = document.getElementById('exportPDF');
    const exportCSV = document.getElementById('exportCSV');
    const historyList = document.getElementById('historyList');
    const clearHistoryBtn = document.getElementById('clearHistory');

    // Initialize theme
    const currentTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    updateThemeLabel();

    // Decimal places state
    let decimalPlaces = parseInt(localStorage.getItem('decimalPlaces') || '2');

    // History storage
    let history = JSON.parse(localStorage.getItem('taxHistory') || '[]');

    const round = (val, decimals = null) => {
      const dp = decimals !== null ? decimals : decimalPlaces;
      const factor = 10 ** dp;
      return Math.round((Number(val) + Number.EPSILON) * factor) / factor;
    };

    const currency = (val, decimals = null) => {
      const dp = decimals !== null ? decimals : decimalPlaces;
      const num = Number(val || 0);
      const formatted = num.toLocaleString('en-US', {
        minimumFractionDigits: dp,
        maximumFractionDigits: dp
      });
      return `GHS ${formatted}`;
    };

    const rates = {
      getfund: 0.025,
      nhil: 0.025,
      covid: 0.01,
      levyTotal: 0.06,
      vat: 0.15
    };

    function updateThemeLabel() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      themeLabel.textContent = isDark ? 'Light' : 'Dark';
    }

    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeLabel();
    });

    decimalPlacesSelect.value = decimalPlaces;
    decimalPlacesSelect.addEventListener('change', (e) => {
      decimalPlaces = parseInt(e.target.value);
      localStorage.setItem('decimalPlaces', decimalPlaces);
      calculate();
      quickReverse();
    });

    function addRow(name = '', price = '', qty = 1) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="item-name" placeholder="Item name" value="${name}"></td>
        <td><input type="number" class="item-price" placeholder="0.00" min="0" step="0.01" value="${price}"></td>
        <td><input type="number" class="item-qty" placeholder="1" min="0" step="1" value="${qty}"></td>
        <td class="line-total">GHS 0.00</td>
        <td><button class="remove" title="Remove row">&times;</button></td>
      `;
      itemsBody.appendChild(tr);

      tr.querySelectorAll('input').forEach(input => input.addEventListener('input', calculate));
      tr.querySelector('.remove').addEventListener('click', () => {
        tr.remove();
        calculate();
      });
      calculate();
    }

    function saveToHistory() {
      const baseTotal = parseFloat(document.getElementById('baseTotal').textContent.replace('GHS ', '')) || 0;
      const finalTotal = parseFloat(document.getElementById('finalTotal').textContent.replace('GHS ', '')) || 0;
      const vat = parseFloat(document.getElementById('vat').textContent.replace('GHS ', '')) || 0;
      const allTaxes = parseFloat(document.getElementById('allTaxes').textContent.replace('GHS ', '')) || 0;
      const getfund = parseFloat(document.getElementById('getfund').textContent.replace('GHS ', '')) || 0;
      const nhil = parseFloat(document.getElementById('nhil').textContent.replace('GHS ', '')) || 0;
      const covid = parseFloat(document.getElementById('covid').textContent.replace('GHS ', '')) || 0;
      const mode = document.querySelector('input[name="mode"]:checked').value;

      if (finalTotal === 0) return;

      const historyItem = {
        timestamp: new Date().toISOString(),
        baseTotal,
        finalTotal,
        vat,
        allTaxes,
        mode,
        items: Array.from(itemsBody.querySelectorAll('tr')).map(row => ({
          name: row.querySelector('.item-name').value,
          price: parseFloat(row.querySelector('.item-price').value) || 0,
          qty: parseFloat(row.querySelector('.item-qty').value) || 0
        }))
      };

      history.unshift(historyItem);
      if (history.length > 15) {
        history = history.slice(0, 15);
      }
      localStorage.setItem('taxHistory', JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      if (history.length === 0) {
        historyList.innerHTML = '<div class="empty-history">No calculations yet. Your recent calculations will appear here.</div>';
        return;
      }

      historyList.innerHTML = history.map((item, index) => {
        const date = new Date(item.timestamp);
        const timeStr = date.toLocaleString();
        return `
          <div class="history-item" data-index="${index}">
            <div class="history-item-header">
              <div class="history-item-time">${timeStr}</div>
              <div class="history-item-total">${currency(item.finalTotal)}</div>
            </div>
            <div class="history-item-details">
              <div>Base: ${currency(item.baseTotal)}</div>
              <div>Taxes: ${currency(item.allTaxes)}</div>
              <div>Mode: ${item.mode === 'exclusive' ? 'Exclusive' : 'Inclusive'}</div>
              <div>Items: ${item.items.length}</div>
            </div>
          </div>
        `;
      }).join('');

      document.querySelectorAll('.history-item').forEach(item => {
        item.addEventListener('click', () => {
          const index = parseInt(item.dataset.index);
          loadHistoryItem(history[index]);
        });
      });
    }

    function loadHistoryItem(item) {
      itemsBody.innerHTML = '';
      item.items.forEach(itemData => {
        addRow(itemData.name, itemData.price.toString(), itemData.qty);
      });
      document.querySelector(`input[name="mode"][value="${item.mode}"]`).checked = true;
      calculate();
    }

    clearHistoryBtn.addEventListener('click', () => {
      if (confirm('Clear all calculation history?')) {
        history = [];
        localStorage.setItem('taxHistory', JSON.stringify(history));
        renderHistory();
      }
    });

    function calculate() {
      const mode = document.querySelector('input[name="mode"]:checked').value;
      document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
      document.querySelector(`.pill input[value="${mode}"]`).parentElement.classList.add('active');
      priceLabel.textContent = mode === 'exclusive' ? '(excl. tax)' : '(incl. tax)';
      modeNote.textContent = mode === 'exclusive'
        ? 'Forward calculation from tax-exclusive prices.'
        : 'Reverse engineering from tax-inclusive prices.';

      let baseTotal = 0;
      const rows = Array.from(itemsBody.querySelectorAll('tr'));

      rows.forEach(row => {
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
        const lineCell = row.querySelector('.line-total');

        if (mode === 'exclusive') {
          const line = price * qty;
          baseTotal += line;
          lineCell.textContent = currency(line, decimalPlaces);
        } else {
          const inclusiveLine = price * qty;
          const baseLine = inclusiveLine / ((1 + rates.levyTotal) * (1 + rates.vat));
          baseTotal += baseLine;
          lineCell.textContent = currency(inclusiveLine, decimalPlaces);
        }
      });

      const getfund = baseTotal * rates.getfund;
      const nhil = baseTotal * rates.nhil;
      const covid = baseTotal * rates.covid;
      const getfundDisplay = round(getfund);
      const nhilDisplay = round(nhil);
      const covidDisplay = round(covid);
      const levyDisplay = round(getfundDisplay + nhilDisplay + covidDisplay);
      const baseDisplay = round(baseTotal);
      const subDisplay = round(baseDisplay + levyDisplay);
      const vatDisplay = round(subDisplay * rates.vat);
      const finalDisplay = round(subDisplay + vatDisplay);
      const allTaxesDisplay = round(levyDisplay + vatDisplay);

      document.getElementById('baseTotal').textContent = currency(baseDisplay);
      document.getElementById('getfund').textContent = currency(getfundDisplay);
      document.getElementById('nhil').textContent = currency(nhilDisplay);
      document.getElementById('covid').textContent = currency(covidDisplay);
      document.getElementById('levyTotal').textContent = currency(levyDisplay);
      document.getElementById('subTotal').textContent = currency(subDisplay);
      document.getElementById('vat').textContent = currency(vatDisplay);
      document.getElementById('allTaxes').textContent = currency(allTaxesDisplay);
      document.getElementById('finalTotal').textContent = currency(finalDisplay);

      saveToHistory();
    }

    function quickReverse() {
      const total = parseFloat(quickFinal.value) || 0;
      const subtotal = total / (1 + rates.vat);
      const base = subtotal / (1 + rates.levyTotal);

      const getfund = base * rates.getfund;
      const nhil = base * rates.nhil;
      const covid = base * rates.covid;
      const levies = getfund + nhil + covid;
      const subPrecise = base + levies;
      const vatPrecise = subPrecise * rates.vat;

      const baseDisplay = round(base, decimalPlaces);
      const getfundDisplay = round(getfund, decimalPlaces);
      const nhilDisplay = round(nhil, decimalPlaces);
      const covidDisplay = round(covid, decimalPlaces);
      const leviesDisplay = round(getfundDisplay + nhilDisplay + covidDisplay, decimalPlaces);
      const subDisplay = round(baseDisplay + leviesDisplay, decimalPlaces);
      let vatDisplay = round(vatPrecise, decimalPlaces);
      let recomputedDisplay = round(subPrecise + vatPrecise, decimalPlaces);

      const remainder = round(total, decimalPlaces) - recomputedDisplay;
      if (Math.abs(remainder) >= 0.001) {
        vatDisplay = round(vatDisplay + remainder, decimalPlaces);
        recomputedDisplay = round(subDisplay + vatDisplay, decimalPlaces);
      }
      const allTaxesDisplay = round(leviesDisplay + vatDisplay, decimalPlaces);

      document.getElementById('quickBase').textContent = currency(baseDisplay, decimalPlaces);
      document.getElementById('quickGetfund').textContent = currency(getfundDisplay, decimalPlaces);
      document.getElementById('quickNhil').textContent = currency(nhilDisplay, decimalPlaces);
      document.getElementById('quickCovid').textContent = currency(covidDisplay, decimalPlaces);
      document.getElementById('quickSub').textContent = currency(subDisplay, decimalPlaces);
      document.getElementById('quickVat').textContent = currency(vatDisplay, decimalPlaces);
      document.getElementById('quickAllTaxes').textContent = currency(allTaxesDisplay, decimalPlaces);
      document.getElementById('quickTotal').textContent = currency(recomputedDisplay, decimalPlaces);
    }

    // Copy functionality
    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const id = btn.dataset.copy;
        const value = document.getElementById(id).textContent;
        navigator.clipboard.writeText(value).then(() => {
          btn.style.color = 'var(--accent-2)';
          setTimeout(() => {
            btn.style.color = '';
          }, 1000);
        });
      });
    });

    // Export functions
    exportScreenshot.addEventListener('click', async () => {
      const card = document.querySelector('.card-strong');
      try {
        const canvas = await html2canvas(card, {
          backgroundColor: getComputedStyle(document.body).backgroundColor,
          scale: 2
        });
        const link = document.createElement('a');
        link.download = `tax-calculator-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL();
        link.click();
      } catch (error) {
        alert('Failed to generate screenshot. Please try again.');
      }
    });

    exportPDF.addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const card = document.querySelector('.card-strong');

      try {
        const canvas = await html2canvas(card, {
          backgroundColor: getComputedStyle(document.body).backgroundColor,
          scale: 2
        });

        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        doc.save(`tax-calculator-${new Date().toISOString().split('T')[0]}.pdf`);
      } catch (error) {
        alert('Failed to generate PDF. Please try again.');
      }
    });

    exportCSV.addEventListener('click', () => {
      const rows = Array.from(itemsBody.querySelectorAll('tr'));
      const mode = document.querySelector('input[name="mode"]:checked').value;

      let csv = 'Item,Price,Qty,Line Total\n';
      rows.forEach(row => {
        const name = row.querySelector('.item-name').value || '';
        const price = row.querySelector('.item-price').value || '0';
        const qty = row.querySelector('.item-qty').value || '0';
        const lineTotal = row.querySelector('.line-total').textContent.replace('GHS ', '');
        csv += `"${name}",${price},${qty},${lineTotal}\n`;
      });

      csv += '\n';
      csv += `Mode,${mode}\n`;
      csv += `Base Total,${document.getElementById('baseTotal').textContent.replace('GHS ', '')}\n`;
      csv += `GETFund,${document.getElementById('getfund').textContent.replace('GHS ', '')}\n`;
      csv += `NHIL,${document.getElementById('nhil').textContent.replace('GHS ', '')}\n`;
      csv += `Covid-19,${document.getElementById('covid').textContent.replace('GHS ', '')}\n`;
      csv += `Total Levies,${document.getElementById('levyTotal').textContent.replace('GHS ', '')}\n`;
      csv += `Subtotal,${document.getElementById('subTotal').textContent.replace('GHS ', '')}\n`;
      csv += `VAT,${document.getElementById('vat').textContent.replace('GHS ', '')}\n`;
      csv += `Total Taxes,${document.getElementById('allTaxes').textContent.replace('GHS ', '')}\n`;
      csv += `Final Total,${document.getElementById('finalTotal').textContent.replace('GHS ', '')}\n`;

      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `tax-calculator-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    });

    document.querySelectorAll('input[name="mode"]').forEach(radio => {
      radio.addEventListener('change', calculate);
    });
    addRowBtn.addEventListener('click', () => addRow());
    quickFinal.addEventListener('input', quickReverse);

    addRow('Sample item', '100', 1);
    renderHistory();
  </script>
</body>

</html>