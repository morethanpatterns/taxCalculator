<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>Tax Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap"
      rel="stylesheet">
    <style>

:root {
  --bg: #0a0e1a;
  --bg-gradient: linear-gradient(135deg, #0a0e1a 0%, #0f1625 100%);
  --panel: #111827;
  --panel-2: #1a2332;
  --border: #1f2937;
  --border-light: rgba(255, 255, 255, 0.08);
  --text: #f1f5f9;
  --text-secondary: #cbd5e1;
  --muted: #94a3b8;
  --export-bg: #0b1220;
  --export-card-bg: #0f172a;
  --export-border: rgba(148, 163, 184, 0.18);
  --export-text: #f8fafc;
  --export-muted: #94a3b8;
  --export-radius: 14px;
  --export-padding: 18px;
  --export-line-height: 1.35;
  --export-shadow: 0 8px 24px rgba(0, 0, 0, 0.28);
  --export-table-head-bg: rgba(148, 163, 184, 0.08);
  --export-table-head-text: rgba(148, 163, 184, 0.95);
  --accent: #ef4444;
  --accent-2: #3b82f6;
  --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
  --shadow-lg: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
  --shadow-sm: 0 4px 16px rgba(0, 0, 0, 0.3);
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --transition: all 0.2s ease;
}

:root[data-theme="light"] {
  --bg: #f8fafc;
  --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  --panel: #ffffff;
  --panel-2: #f8fafc;
  --border: #e2e8f0;
  --border-light: rgba(0, 0, 0, 0.06);
  --text: #0f172a;
  --text-secondary: #334155;
  --muted: #64748b;
  --export-bg: #ffffff;
  --export-card-bg: #ffffff;
  --export-border: #e2e8f0;
  --export-text: #0f172a;
  --export-muted: #475569;
  --export-radius: 14px;
  --export-padding: 18px;
  --export-line-height: 1.35;
  --export-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
  --export-table-head-bg: #f1f5f9;
  --export-table-head-text: #475569;
  --accent: #ef4444;
  --accent-2: #3b82f6;
  --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  --shadow: 0 20px 60px rgba(15, 23, 42, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.04);
  --shadow-lg: 0 25px 80px rgba(15, 23, 42, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.04);
  --shadow-sm: 0 4px 16px rgba(0, 0, 0, 0.06);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body.export-mode {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body.export-mode *,
.export-mode * {
  animation: none !important;
  transition: none !important;
}

body.export-mode [data-export-hide="true"],
body.export-mode .export-hide,
.export-mode [data-export-hide="true"],
.export-mode .export-hide {
  display: none !important;
}

.export-mode:not(body) {
  color: var(--export-text) !important;
  background: var(--export-card-bg) !important;
  border: 1px solid var(--export-border) !important;
  border-radius: var(--export-radius) !important;
  box-shadow: var(--export-shadow) !important;
  line-height: var(--export-line-height) !important;
  opacity: 1 !important;
  filter: none !important;
  backdrop-filter: none !important;
}

.export-mode:not(body) .muted {
  color: var(--export-muted) !important;
}

body.export-mode .journal-modal-overlay {
  background: transparent !important;
  backdrop-filter: none !important;
}

.export-mode.journal-modal-content {
  overflow: visible !important;
  max-height: none !important;
}

body.export-mode *::-webkit-scrollbar {
  width: 0 !important;
  height: 0 !important;
}

.export-footer {
  display: none;
  margin-top: 14px;
  padding-top: 10px;
  border-top: 1px solid var(--export-border);
  font-size: 11px;
  color: var(--export-muted);
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  white-space: nowrap;
}

.journal-modal-content .export-footer {
  padding: 10px 24px 16px;
  margin-top: 0;
}

body.export-mode .export-footer,
.export-mode .export-footer {
  display: flex;
}

body {
  font-family: "Plus Jakarta Sans", "Space Grotesk", system-ui, -apple-system, sans-serif;
  background: var(--bg-gradient);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.6;
}

button,
input,
select {
  font-family: inherit;
}

.content {
  width: min(1800px, 100%);
  margin: 0 auto;
  padding: 24px 32px 48px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.page-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border-light);
}

.page-title {
  font-size: clamp(22px, 2.6vmin, 30px);
  font-weight: 700;
  margin: 4px 0;
  letter-spacing: -0.02em;
}

.page-subtitle {
  color: var(--muted);
  font-size: clamp(12px, 1.3vmin, 14px);
}

.page-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.settings-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-height: 0;
}

.eyebrow {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--muted);
  font-weight: 700;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}

.section-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0;
}

.text-center {
  text-align: center;
}

.muted {
  color: var(--muted);
}

.small {
  font-size: 12px;
}

.numeric {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

.hero-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.btn {
  padding: 10px 18px;
  border: 1px solid transparent;
  border-radius: 12px;
  background: var(--accent-gradient);
  color: #ffffff;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  box-shadow: var(--shadow-sm);
  height: 40px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  transition: var(--transition);
}

.btn-secondary {
  background: #ffffff;
  color: var(--accent-2);
  border: 1px solid var(--accent-2);
}

.btn-secondary:hover {
  background: rgba(43, 140, 254, 0.1);
}

:root[data-theme="light"] .btn-secondary {
  background: #ffffff;
}

.btn-small {
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 13px;
  height: 32px;
}

.btn-ghost {
  padding: 6px 10px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text);
  cursor: pointer;
  transition: var(--transition);
}

.btn-ghost:hover {
  border-color: var(--accent-2);
  color: var(--accent-2);
}

.analytics-chip {
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border-light);
  background: var(--panel-2);
  color: var(--text);
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.analytics-chip.active {
  border-color: var(--accent-2);
  box-shadow: var(--shadow-sm);
  color: var(--accent-2);
}

.settings-card {
  background-color: var(--panel);
  border: 1px solid var(--border);
  border-radius: 0.75rem;
  padding: 1.5rem;
  box-shadow: var(--shadow);
}

.settings-form-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1rem;
  margin-bottom: 0.75rem;
}

.settings-form-col {
  display: flex;
  flex-direction: column;
}

.settings-form-col label {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: var(--text);
}

.settings-form-col input,
.settings-form-col select {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--panel-2);
  color: var(--text);
  font-size: 14px;
}

.settings-form-col input:focus,
.settings-form-col select:focus {
  outline: none;
  border-color: var(--accent-2);
  background: var(--panel);
}

input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  opacity: 0.55;
}

:root[data-theme="light"] input[type="number"]::-webkit-inner-spin-button,
:root[data-theme="light"] input[type="number"]::-webkit-outer-spin-button {
  opacity: 0.2;
}

:root[data-theme="light"] input[type="number"] {
  color-scheme: light;
}

:root[data-theme="dark"] input[type="number"] {
  color-scheme: dark;
}

.coa-table-wrapper {
  background: var(--panel);
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 16px;
  box-shadow: var(--shadow);
  overflow-x: auto;
}

.coa-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 520px;
}

.coa-table thead {
  border-bottom: 2px solid var(--border);
}

.coa-table th {
  padding: 10px 12px;
  text-align: left;
  font-weight: 600;
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.coa-table td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
  color: var(--text);
}

.coa-table tbody tr:last-child td {
  border-bottom: none;
}

.analytics-kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
}

.analytics-kpi {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 12px;
  box-shadow: var(--shadow-sm);
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 0;
}

.analytics-kpi .kpi-label {
  margin: 0;
  font-size: 12px;
}

.analytics-kpi .kpi-value {
  font-size: 20px;
  font-weight: 900;
  letter-spacing: -0.02em;
  line-height: 1.15;
  color: var(--text);
  font-variant-numeric: tabular-nums;
}

.analytics-kpi .kpi-caption {
  font-size: 11px;
  font-weight: 700;
  color: var(--muted);
  line-height: 1.25;
}

.tax-levies-layout {
  display: grid;
  grid-template-columns: 1.6fr 1fr;
  gap: 16px;
  align-items: start;
}

.tax-levies-side {
  display: grid;
  gap: 16px;
  align-content: start;
}

.tax-levies-controls {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.tax-levies-mode {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.tax-levies-precision {
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 180px;
}

.tax-levies-precision select,
.coa-filter-select {
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--border-light);
  background: var(--panel-2);
  color: var(--text);
  font-size: 13px;
}

.tax-levies-items-actions {
  margin-top: 10px;
  display: flex;
  justify-content: flex-end;
}

.tax-levies-input {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--panel-2);
  color: var(--text);
  font-size: 14px;
}

.tax-levies-input:focus {
  outline: none;
  border-color: var(--accent-2);
  background: var(--panel);
}

.tax-levies-items-table .tax-item-price,
.tax-levies-items-table .tax-item-qty {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

.tax-levies-history-list {
  display: grid;
  gap: 12px;
}

.tax-levies-history-item {
  border: 1px solid var(--border-light);
  background: var(--panel-2);
  border-radius: 14px;
  padding: 12px;
  display: grid;
  gap: 8px;
}

.tax-levies-history-meta {
  font-size: 12px;
  font-weight: 800;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.tax-levies-history-summary {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  font-size: 13px;
  font-weight: 800;
  color: var(--text);
  font-variant-numeric: tabular-nums;
  flex-wrap: wrap;
}

.tax-levies-history-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  flex-wrap: wrap;
}

.tax-levies-rates summary {
  cursor: pointer;
  font-weight: 800;
}

.tax-levies-rates-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
}

.tax-levies-rate-row {
  display: grid;
  gap: 6px;
}

.tax-levies-rate-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.tax-levies-rate-input {
  max-width: 120px;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

.tax-levies-rate-toggle {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 700;
  color: var(--muted);
}

.tax-levies-rate-toggle input {
  accent-color: var(--accent-2);
}

.tax-levies-rate-note {
  margin-top: 8px;
}

.actions-cell {
  text-align: right;
  white-space: nowrap;
}

.journal-modal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 24px;
}

.journal-modal-overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
}

.journal-modal-content {
  position: relative;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 14px;
  box-shadow: var(--shadow);
  width: min(920px, calc(100vw - 48px));
  max-height: 85vh;
  overflow: hidden;
  z-index: 1001;
  animation: slideUp 0.3s ease;
}

.journal-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid var(--border);
}

.journal-modal-header h2 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

.journal-modal-close {
  background: transparent;
  border: none;
  color: var(--text);
  font-size: 32px;
  line-height: 1;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  transition: background 0.2s ease;
}

.journal-modal-close:hover {
  background: var(--panel-2);
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(16px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 900px) {
  .page-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .page-actions {
    width: 100%;
    justify-content: flex-start;
  }

  .section-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .hero-actions {
    width: 100%;
    flex-wrap: wrap;
  }

  .tax-levies-controls {
    flex-direction: column;
    align-items: flex-start;
  }

  .tax-levies-mode,
  .tax-levies-precision {
    width: 100%;
  }

  .tax-levies-precision select {
    width: 100%;
  }

  .analytics-kpi-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (max-width: 980px) {
  .tax-levies-layout {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 720px) {
  .content {
    padding: 18px 16px 36px;
  }

  .settings-card {
    padding: 1.1rem;
  }

  .coa-table th,
  .coa-table td {
    padding: 8px 10px;
    font-size: 13px;
  }

  .journal-modal {
    padding: 16px;
  }

  .journal-modal-content {
    width: min(920px, calc(100vw - 32px));
    max-height: 80vh;
  }
}

@media (max-width: 600px) {
  .page-actions .btn,
  .hero-actions .btn {
    width: 100%;
    justify-content: center;
  }

  .tax-levies-mode {
    flex-direction: column;
    align-items: stretch;
  }

  .tax-levies-mode .analytics-chip {
    width: 100%;
  }

  .analytics-kpi-grid {
    grid-template-columns: 1fr;
  }

  .tax-levies-rates-grid {
    grid-template-columns: 1fr;
  }
}

    </style>
    <script>
      (function () {
        const themeKey = "tax-calculator-theme";
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const saved = localStorage.getItem(themeKey);
        const theme = saved || (prefersDark ? "dark" : "light");
        document.documentElement.setAttribute("data-theme", theme);
      })();
    </script>
  </head>
  <body>
    <main class="content">
      <header class="page-header">
        <div>
          <p class="eyebrow">Ghana</p>
          <h1 class="page-title">Tax Calculator</h1>
          <p class="page-subtitle">Utility tax and levies calculator with adjustable rates.</p>
        </div>
        <div class="page-actions">
          <button class="btn btn-secondary btn-small" id="themeToggle" type="button">Toggle theme</button>
        </div>
      </header>

      <div class="settings-container">
        <div id="tax-levies-content">
          <div class="text-center muted">Loading tax calculator...</div>
        </div>
      </div>
    </main>

    <script>
      (function () {
        const themeKey = "tax-calculator-theme";
        const toggle = document.getElementById("themeToggle");
        if (!toggle) return;

        const setLabel = (theme) => {
          toggle.textContent = theme === "dark" ? "Switch to light" : "Switch to dark";
        };

        const applyTheme = (theme) => {
          document.documentElement.setAttribute("data-theme", theme);
          localStorage.setItem(themeKey, theme);
          setLabel(theme);
        };

        const current = document.documentElement.getAttribute("data-theme") || "dark";
        setLabel(current);

        toggle.addEventListener("click", () => {
          const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
          applyTheme(next);
        });
      })();
    </script>

    <script>
// Snapshot / Export (standalone)
window.ensureHtml2Canvas = async function ensureHtml2Canvas() {
  if (window.html2canvas) return window.html2canvas;

  const existingScript = document.getElementById("html2canvas-cdn");
  if (existingScript) {
    return new Promise((resolve, reject) => {
      existingScript.addEventListener("load", () => resolve(window.html2canvas), { once: true });
      existingScript.addEventListener(
        "error",
        () => reject(new Error("Failed to load html2canvas")),
        { once: true }
      );
    });
  }

  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.id = "html2canvas-cdn";
    script.src =
      "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
    script.onload = () => resolve(window.html2canvas);
    script.onerror = () => reject(new Error("Failed to load html2canvas"));
    document.head.appendChild(script);
  });
};

window.formatLocalTimestamp = function formatLocalTimestamp(date = new Date()) {
  const d = date instanceof Date ? date : new Date(date);
  const pad = (n) => String(n).padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(
    d.getHours()
  )}:${pad(d.getMinutes())}`;
};

window.captureSnapshot = async function captureSnapshot({
  rootEl,
  moduleName = "Tax Calculator",
  filename = "snapshot",
  onBeforeCapture,
  onAfterCapture,
} = {}) {
  if (!rootEl || !(rootEl instanceof Element)) {
    throw new Error("captureSnapshot: rootEl must be a DOM Element");
  }

  const notify = (message, type = "info") => {
    if (typeof window.showCustomAlert === "function") {
      window.showCustomAlert(message, type);
      return;
    }
    alert(message);
  };

  const body = document.body;
  const addedBodyClass = !body.classList.contains("export-mode");
  const addedRootClass = !rootEl.classList.contains("export-mode");

  const prevInline = {
    overflow: rootEl.style.overflow,
    maxHeight: rootEl.style.maxHeight,
  };

  let footerEl = null;
  try {
    body.classList.add("export-mode");
    rootEl.classList.add("export-mode");

    rootEl.style.overflow = "visible";
    rootEl.style.maxHeight = "none";

    footerEl = document.createElement("div");
    footerEl.className = "export-footer";
    footerEl.dataset.exportFooter = "true";

    const left = document.createElement("span");
    left.textContent = `Generated from ${moduleName}`;
    const right = document.createElement("span");
    right.textContent = window.formatLocalTimestamp(new Date());

    footerEl.appendChild(left);
    footerEl.appendChild(right);
    rootEl.appendChild(footerEl);

    if (typeof onBeforeCapture === "function") {
      await onBeforeCapture({ rootEl, footerEl });
    }

    await new Promise((resolve) => requestAnimationFrame(resolve));
    await new Promise((resolve) => requestAnimationFrame(resolve));

    const h2c = await window.ensureHtml2Canvas();
    const exportBg =
      getComputedStyle(document.documentElement).getPropertyValue("--export-bg").trim() ||
      "#ffffff";
    const computedBg = getComputedStyle(rootEl).backgroundColor;
    const backgroundColor =
      computedBg && computedBg !== "rgba(0, 0, 0, 0)" && computedBg !== "transparent"
        ? computedBg
        : exportBg;

    const canvas = await h2c(rootEl, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor,
    });

    const blob = await new Promise((resolve, reject) => {
      canvas.toBlob((b) => (b ? resolve(b) : reject(new Error("Could not render image"))), "image/png");
    });

    const canClipboardWrite =
      navigator.clipboard &&
      typeof navigator.clipboard.write === "function" &&
      typeof window.ClipboardItem !== "undefined";

    if (canClipboardWrite) {
      try {
        await navigator.clipboard.write([
          new window.ClipboardItem({ "image/png": blob }),
        ]);
        notify("Copied snapshot to clipboard.", "success");
        return;
      } catch (e) {
        console.warn("Clipboard write failed, falling back to download:", e);
      }
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${filename}.png`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    notify("Downloaded PNG (clipboard not available).", "info");
  } catch (e) {
    console.error("Snapshot export failed:", e);
    notify("Snapshot export failed. Please check your connection.", "error");
  } finally {
    try {
      if (typeof onAfterCapture === "function") {
        await onAfterCapture({ rootEl, footerEl });
      }
    } catch (e) {
      console.warn("captureSnapshot cleanup failed:", e);
    }

    if (footerEl && footerEl.parentNode) footerEl.parentNode.removeChild(footerEl);

    rootEl.style.overflow = prevInline.overflow;
    rootEl.style.maxHeight = prevInline.maxHeight;

    if (addedRootClass) rootEl.classList.remove("export-mode");
    if (addedBodyClass) body.classList.remove("export-mode");
  }
};

// Sales -> Tax / Levies Calculator (Ghana)
(function () {
  "use strict";

  const HISTORY_KEY = "taxLeviesHistory";
  const MAX_HISTORY = 20;

  const DEFAULT_RATES = {
    getfund: 0.025,
    nhil: 0.025,
    covid19: 0.01,
    vat: 0.15,
  };

  const DEFAULT_RATE_ENABLED = {
    getfund: true,
    nhil: true,
    covid19: true,
    vat: true,
  };

  const currencyFormatters = new Map();
  const numberFormatters = new Map();

  const getCurrencyFormatter = (dp) => {
    const key = String(dp);
    if (currencyFormatters.has(key)) return currencyFormatters.get(key);
    const fmt = new Intl.NumberFormat("en-GH", {
      style: "currency",
      currency: "GHS",
      minimumFractionDigits: dp,
      maximumFractionDigits: dp,
    });
    currencyFormatters.set(key, fmt);
    return fmt;
  };

  const getNumberFormatter = (dp) => {
    const key = String(dp);
    if (numberFormatters.has(key)) return numberFormatters.get(key);
    const fmt = new Intl.NumberFormat("en-US", {
      minimumFractionDigits: dp,
      maximumFractionDigits: dp,
    });
    numberFormatters.set(key, fmt);
    return fmt;
  };

  const formatGhc = (value, dp = 2) => getCurrencyFormatter(dp).format(Number(value || 0));
  const formatFixed = (value, dp = 2) => getNumberFormatter(dp).format(Number(value || 0));

  function toPreciseNumber(value) {
    if (value === null || value === undefined || value === "") return 0;
    const num =
      typeof value === "string" ? parseFloat(value.replace(/,/g, "")) : parseFloat(value);
    if (Number.isNaN(num)) return 0;
    return parseFloat(num.toFixed(4));
  }

  function safeNumber(value) {
    const n = typeof value === "string" ? parseFloat(value) : Number(value);
    return Number.isFinite(n) ? n : 0;
  }

  function normalizeRates(rates = {}) {
    return {
      getfund: Math.max(0, safeNumber(rates.getfund)),
      nhil: Math.max(0, safeNumber(rates.nhil)),
      covid19: Math.max(0, safeNumber(rates.covid19)),
      vat: Math.max(0, safeNumber(rates.vat)),
    };
  }

  function normalizeEnabledRates(enabled = {}) {
    return {
      getfund: enabled.getfund !== false,
      nhil: enabled.nhil !== false,
      covid19: enabled.covid19 !== false,
      vat: enabled.vat !== false,
    };
  }

  function getActiveRates(rates = state.rates, enabled = state.enabledRates) {
    const normalized = normalizeRates(rates);
    const flags = normalizeEnabledRates(enabled);
    return {
      getfund: flags.getfund ? normalized.getfund : 0,
      nhil: flags.nhil ? normalized.nhil : 0,
      covid19: flags.covid19 ? normalized.covid19 : 0,
      vat: flags.vat ? normalized.vat : 0,
    };
  }

  function getLeviesRate(rates) {
    const normalized = normalizeRates(rates);
    return normalized.getfund + normalized.nhil + normalized.covid19;
  }

  function getGrossFactor(rates) {
    const normalized = normalizeRates(rates);
    return (1 + getLeviesRate(normalized)) * (1 + normalized.vat);
  }

  function formatRatePercent(rate) {
    const value = safeNumber(rate) * 100;
    const rounded = Math.round((value + Number.EPSILON) * 10) / 10;
    const isWhole = Math.abs(rounded - Math.round(rounded)) < 0.0001;
    return isWhole ? String(Math.round(rounded)) : rounded.toFixed(1);
  }

  function formatRateInputValue(rate) {
    const value = safeNumber(rate) * 100;
    const rounded = Math.round((value + Number.EPSILON) * 1000) / 1000;
    return String(rounded);
  }

  function formatRateLabel(label, rate) {
    return `${label} (${formatRatePercent(rate)}%)`;
  }

  function sanitizeDisplayDp(value) {
    const dp = Number(value);
    return dp === 2 || dp === 3 || dp === 4 ? dp : 2;
  }

  function getEntryRates(entry, fallbackRates) {
    if (entry?.rates) return normalizeRates(entry.rates);
    if (fallbackRates) return normalizeRates(fallbackRates);
    return getActiveRates();
  }

  function getEntryEnabled(entry, fallbackEnabled) {
    if (entry?.enabledRates) return normalizeEnabledRates(entry.enabledRates);
    if (fallbackEnabled) return normalizeEnabledRates(fallbackEnabled);
    return normalizeEnabledRates();
  }

  function copyText(text) {
    const notify = (message, type = "info") => {
      if (typeof window.showCustomAlert === "function") {
        window.showCustomAlert(message, type);
        return;
      }
      alert(message);
    };

    const str = String(text || "");
    if (!str) {
      notify("Nothing to copy.", "info");
      return;
    }
    navigator.clipboard
      .writeText(str)
      .then(() => notify("Copied to clipboard.", "success"))
      .catch(() => prompt("Copy manually:", str));
  }

  function loadHistory() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      return Array.isArray(parsed) ? parsed : [];
    } catch (_) {
      return [];
    }
  }

  function saveHistory(history) {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    } catch (_) {}
  }

  function calculateFromBase(baseTotal, rates) {
    const activeRates = normalizeRates(rates);
    const base = toPreciseNumber(baseTotal);
    const getfund = toPreciseNumber(base * activeRates.getfund);
    const nhil = toPreciseNumber(base * activeRates.nhil);
    const covid19 = toPreciseNumber(base * activeRates.covid19);
    const leviesTotal = toPreciseNumber(getfund + nhil + covid19);
    const subtotalAfterLevies = toPreciseNumber(base + leviesTotal);
    const vat = toPreciseNumber(subtotalAfterLevies * activeRates.vat);
    const total = toPreciseNumber(subtotalAfterLevies + vat);
    const taxesTotal = toPreciseNumber(leviesTotal + vat);
    return {
      base,
      getfund,
      nhil,
      covid19,
      leviesTotal,
      subtotalAfterLevies,
      vat,
      taxesTotal,
      total,
      roundingAdjustment: 0,
      roundingAppliedTo: null,
    };
  }

  function calculateFromGross(grossTotal, rates) {
    const activeRates = normalizeRates(rates);
    const inputGross = toPreciseNumber(grossTotal);
    const grossFactor = getGrossFactor(activeRates);
    const impliedBase = toPreciseNumber(grossFactor ? inputGross / grossFactor : 0);
    const breakdown = calculateFromBase(impliedBase, activeRates);
    const diff = toPreciseNumber(inputGross - breakdown.total);
    if (Math.abs(diff) >= 0.0001) {
      breakdown.vat = toPreciseNumber(breakdown.vat + diff);
      breakdown.total = toPreciseNumber(breakdown.total + diff);
      breakdown.taxesTotal = toPreciseNumber(breakdown.leviesTotal + breakdown.vat);
      breakdown.roundingAdjustment = diff;
      breakdown.roundingAppliedTo = "VAT";
    }
    return { inputGross, ...breakdown };
  }

  function computeItemsTotals(items, mode, rates) {
    const activeRates = normalizeRates(rates);
    const normalized = (items || []).map((it) => {
      const name = String(it.name || "").trim();
      const qty = safeNumber(it.qty);
      const price = safeNumber(it.price);
      const lineTotal = toPreciseNumber(price * qty);
      return {
        id: it.id,
        name,
        qty,
        price,
        lineTotal,
      };
    });

    const totalQty = normalized.reduce((sum, it) => sum + (it.qty || 0), 0);
    const inputTotal = toPreciseNumber(
      normalized.reduce((sum, it) => sum + (it.lineTotal || 0), 0)
    );

    const breakdown =
      mode === "inclusive"
        ? calculateFromGross(inputTotal, activeRates)
        : calculateFromBase(inputTotal, activeRates);

    const payload = {
      mode,
      items: normalized,
      totalQty: toPreciseNumber(totalQty),
      inputTotal,
      rates: activeRates,
      ...breakdown,
    };

    return payload;
  }

  function getModeLabel(mode) {
    if (mode === "inclusive") return "Inclusive (reverse)";
    if (mode === "exclusive") return "Exclusive (forward)";
    if (mode === "quick") return "Quick reverse (total only)";
    return String(mode || "");
  }

  function buildWhatsappSummary(entry) {
    const mode = entry?.mode;
    const totalsDp = sanitizeDisplayDp(entry?.displayDp);
    const rates = getEntryRates(entry);
    const enabled = getEntryEnabled(entry);

    const modeText =
      mode === "exclusive"
        ? "Exclusive"
        : mode === "inclusive"
        ? "Inclusive"
        : mode === "quick"
        ? "Reverse"
        : String(mode || "").trim() || "Reverse";

    const inputLabel = mode === "exclusive" ? "Input Base" : "Input Total";
    const inputAmount =
      mode === "exclusive"
        ? entry?.inputTotal ?? entry?.base ?? 0
        : entry?.inputTotal ?? entry?.inputGross ?? 0;

    const baseHeader = mode === "exclusive" ? "Base" : "Implied Base";
    const totalHeader = mode === "exclusive" ? "Final Total" : "Recomputed Total";

    const lines = [
      "*Tax / Levies Breakdown (Ghana)*",
      `_Mode:_ ${modeText}`,
      `*${inputLabel}:* ${formatGhc(inputAmount, totalsDp)}`,
      "",
      `*${baseHeader}*`,
      `*${formatGhc(entry?.base ?? 0, 4)}*`,
      "",
    ];

    const levyLines = [];
    if (enabled.getfund) {
      levyLines.push(
        `- ${formatRateLabel("GETFund", rates.getfund)}: ${formatGhc(entry?.getfund ?? 0, 4)}`
      );
    }
    if (enabled.nhil) {
      levyLines.push(
        `- ${formatRateLabel("NHIL", rates.nhil)}: ${formatGhc(entry?.nhil ?? 0, 4)}`
      );
    }
    if (enabled.covid19) {
      levyLines.push(
        `- ${formatRateLabel("COVID", rates.covid19)}: ${formatGhc(entry?.covid19 ?? 0, 4)}`
      );
    }
    if (levyLines.length) {
      lines.push(
        "*Levies*",
        ...levyLines,
        "",
        `_*Subtotal after levies: ${formatGhc(entry?.subtotalAfterLevies ?? 0, 4)}*_`,
        ""
      );
    }

    if (enabled.vat) {
      lines.push(
        "*VAT*",
        `- ${formatRateLabel("VAT", rates.vat)}: ${formatGhc(entry?.vat ?? 0, 4)}`,
        ""
      );
    }

    lines.push(
      "*Totals*",
      `_*Total Taxes: ${formatGhc(entry?.taxesTotal ?? 0, 4)}*_`,
      `*${totalHeader.toUpperCase()}:* *${formatGhc(entry?.total ?? 0, totalsDp)}*`
    );

    if (Math.abs(entry?.roundingAdjustment || 0) >= 0.0001) {
      lines.push("", "_Rounding adjustment applied._");
    }

    return lines.join("\n");
  }

  function buildPlainTextBreakdown(entry) {
    const mode = entry.mode === "quick" ? "inclusive" : entry.mode;
    const baseLabel = mode === "exclusive" ? "Base" : "Implied base";
    const totalLabel = mode === "exclusive" ? "Final total" : "Recomputed total";
    const rates = getEntryRates(entry);
    const enabled = getEntryEnabled(entry);
    const leviesEnabled = enabled.getfund || enabled.nhil || enabled.covid19;
    const rows = [[baseLabel, formatGhc(entry.base, 4)]];
    if (enabled.getfund) {
      rows.push([formatRateLabel("GETFund", rates.getfund), formatGhc(entry.getfund, 4)]);
    }
    if (enabled.nhil) {
      rows.push([formatRateLabel("NHIL", rates.nhil), formatGhc(entry.nhil, 4)]);
    }
    if (enabled.covid19) {
      rows.push([formatRateLabel("COVID", rates.covid19), formatGhc(entry.covid19, 4)]);
    }
    if (leviesEnabled) {
      rows.push(["Subtotal after levies", formatGhc(entry.subtotalAfterLevies, 4)]);
    }
    if (enabled.vat) {
      rows.push([formatRateLabel("VAT", rates.vat), formatGhc(entry.vat, 4)]);
    }
    rows.push(["Total taxes", formatGhc(entry.taxesTotal, 4)]);
    rows.push([totalLabel, formatGhc(entry.total, 2)]);
    const leftWidth = rows.reduce((max, [label]) => Math.max(max, label.length), 0);
    const lines = rows.map(([label, value]) => `${label.padEnd(leftWidth)}  ${value}`);
    if (Math.abs(entry.roundingAdjustment || 0) >= 0.0001) {
      lines.push(
        `Rounding adj (to ${entry.roundingAppliedTo || "VAT"})`.padEnd(leftWidth) +
          `  ${formatGhc(entry.roundingAdjustment, 4)}`
      );
    }
    return lines.join("\n");
  }

  function buildBreakdownTableRows(mode, entry, dp) {
    const baseLabel = mode === "exclusive" ? "Base" : "Implied base";
    const totalLabel = mode === "exclusive" ? "Final total" : "Recomputed total";
    const rates = getEntryRates(entry);
    const enabled = getEntryEnabled(entry);
    const leviesEnabled = enabled.getfund || enabled.nhil || enabled.covid19;
    const levyRows = [
      enabled.getfund
        ? `<tr><td>${formatRateLabel("GETFund", rates.getfund)}</td><td class="numeric">${formatGhc(
            entry.getfund,
            dp
          )}</td></tr>`
        : "",
      enabled.nhil
        ? `<tr><td>${formatRateLabel("NHIL", rates.nhil)}</td><td class="numeric">${formatGhc(
            entry.nhil,
            dp
          )}</td></tr>`
        : "",
      enabled.covid19
        ? `<tr><td>${formatRateLabel("COVID", rates.covid19)}</td><td class="numeric">${formatGhc(
            entry.covid19,
            dp
          )}</td></tr>`
        : "",
    ]
      .filter(Boolean)
      .join("");
    const leviesTotalRow = leviesEnabled
      ? `<tr><td style="font-weight:700;">Levies total</td><td class="numeric" style="font-weight:700;">${formatGhc(
          entry.leviesTotal,
          dp
        )}</td></tr>`
      : "";
    const subtotalRow = leviesEnabled
      ? `<tr><td>Subtotal after levies</td><td class="numeric">${formatGhc(
          entry.subtotalAfterLevies,
          dp
        )}</td></tr>`
      : "";
    const vatRow = enabled.vat
      ? `<tr><td>${formatRateLabel("VAT", rates.vat)}</td><td class="numeric">${formatGhc(
          entry.vat,
          dp
        )}</td></tr>`
      : "";
    return `
      <tr><td>${baseLabel}</td><td class="numeric">${formatGhc(entry.base, dp)}</td></tr>
      ${levyRows}
      ${leviesTotalRow}
      ${subtotalRow}
      ${vatRow}
      <tr><td style="font-weight:700;">Total taxes</td><td class="numeric" style="font-weight:700;">${formatGhc(
        entry.taxesTotal,
        dp
      )}</td></tr>
      <tr style="border-top:2px solid var(--border); font-weight:900;">
        <td>${totalLabel}</td>
        <td class="numeric">${formatGhc(entry.total, dp)}</td>
      </tr>
    `;
  }

  function openHistoryModal(entry, { autoSnapshot = false } = {}) {
    const createdAt = entry.createdAt ? new Date(entry.createdAt) : new Date();
    const timestamp =
      typeof window.formatLocalTimestamp === "function"
        ? window.formatLocalTimestamp(createdAt)
        : createdAt.toLocaleString();
    const modeLabel = getModeLabel(entry.mode);
    const dp = 4;
    const inputLabel = entry.mode === "exclusive" ? "Input base" : "Input total";
    const inputAmount =
      entry.mode === "exclusive"
        ? safeNumber(entry.base)
        : safeNumber(entry.inputTotal ?? entry.inputGross ?? 0);

    const items = Array.isArray(entry.items) ? entry.items : [];
    const itemsQty = items.reduce((sum, it) => sum + safeNumber(it.qty), 0);
    const itemsTable =
      items.length > 0
        ? `
          <div class="muted small" style="margin: 8px 0 10px;">Items</div>
          <div class="coa-table-wrapper modern-table" style="padding: 16px;">
            <table class="coa-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="numeric">Qty</th>
                  <th class="numeric">Price</th>
                  <th class="numeric">Line total</th>
                </tr>
              </thead>
              <tbody>
                ${items
                  .map((it) => {
                    const name = it.name ? String(it.name) : "Item";
                    const qty = safeNumber(it.qty);
                    const price = safeNumber(it.price);
                    const lineTotal = toPreciseNumber(price * qty);
                    return `
                      <tr>
                        <td>${name}</td>
                        <td class="numeric">${formatFixed(qty, 0)}</td>
                        <td class="numeric">${formatGhc(price, dp)}</td>
                        <td class="numeric">${formatGhc(lineTotal, dp)}</td>
                      </tr>
                    `;
                  })
                  .join("")}
              </tbody>
            </table>
          </div>
        `
        : "";

    const modal = document.createElement("div");
    modal.className = "journal-modal";
    modal.innerHTML = `
      <div class="journal-modal-overlay"></div>
      <div class="journal-modal-content tax-levies-modal">
        <div class="journal-modal-header">
          <h2>Tax / Levies Breakdown</h2>
          <div style="display:flex; gap:8px; align-items:center;" data-export-hide="true">
            <button type="button" class="btn btn-secondary btn-small" id="tax-levies-modal-copy-text">Copy WhatsApp</button>
            <button type="button" class="btn btn-secondary btn-small" id="tax-levies-modal-copy-table">Copy table</button>
            <button type="button" class="btn btn-secondary btn-small" id="tax-levies-modal-copy-snapshot">Copy snapshot</button>
            <button class="journal-modal-close" type="button" aria-label="Close" id="tax-levies-modal-close">&times;</button>
          </div>
        </div>
        <div style="padding: 24px;">
          <div class="muted small" style="margin-bottom: 10px;">${timestamp} | ${modeLabel}</div>
          <div style="display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:10px; margin-bottom: 10px;">
            <div>
              <div class="muted small">${inputLabel}</div>
              <div style="font-weight:900; font-variant-numeric: tabular-nums;">${formatGhc(
                inputAmount,
                2
              )}</div>
            </div>
            <div>
              <div class="muted small">Total taxes</div>
              <div style="font-weight:900; font-variant-numeric: tabular-nums;">${formatGhc(
                entry.taxesTotal || 0,
                2
              )}</div>
            </div>
          </div>
          ${
            items.length > 0
              ? `<div class="muted small" style="margin-bottom: 10px;">Items: ${items.length} | Qty: ${formatFixed(
                  itemsQty,
                  0
                )}</div>`
              : ""
          }
          ${itemsTable}
          <div class="muted small" style="margin: 12px 0 10px;">Breakdown</div>
          <div class="coa-table-wrapper modern-table" style="padding: 16px;">
            <table class="coa-table">
              <tbody>
                ${buildBreakdownTableRows(entry.mode === "quick" ? "inclusive" : entry.mode, entry, dp)}
              </tbody>
            </table>
          </div>
          <div class="muted small" id="tax-levies-modal-adjustment" style="margin-top: 10px; display:${
            Math.abs(entry.roundingAdjustment || 0) >= 0.0001 ? "block" : "none"
          };">
            Rounding adjustment applied to ${entry.roundingAppliedTo || "VAT"}: ${formatGhc(
              entry.roundingAdjustment || 0,
              4
            )}
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(modal);
    modal.style.display = "flex";

    const close = () => modal.remove();
    modal.querySelector(".journal-modal-overlay")?.addEventListener("click", close);
    modal.querySelector("#tax-levies-modal-close")?.addEventListener("click", close);

    modal
      .querySelector("#tax-levies-modal-copy-text")
      ?.addEventListener("click", () => copyText(buildWhatsappSummary(entry)));

    modal
      .querySelector("#tax-levies-modal-copy-table")
      ?.addEventListener("click", () => copyText(buildPlainTextBreakdown(entry)));

    modal
      .querySelector("#tax-levies-modal-copy-snapshot")
      ?.addEventListener("click", async () => {
        const content = modal.querySelector(".journal-modal-content");
        if (!content) return;
        if (typeof window.captureSnapshot !== "function") {
          alert("Snapshot export is not available. Please reload the page.");
          return;
        }
        await window.captureSnapshot({
          rootEl: content,
          moduleName: "Tax Calculator",
          filename: `tax-levies-${entry.id || Date.now()}`,
        });
      });

    if (autoSnapshot) {
      setTimeout(async () => {
        try {
          const content = modal.querySelector(".journal-modal-content");
          if (!content || typeof window.captureSnapshot !== "function") return;
          await window.captureSnapshot({
            rootEl: content,
            moduleName: "Tax Calculator",
            filename: `tax-levies-${entry.id || Date.now()}`,
          });
        } finally {
          close();
        }
      }, 50);
    }

    return modal;
  }

  const state = {
    mode: "exclusive",
    displayDp: 2,
    rates: { ...DEFAULT_RATES },
    enabledRates: { ...DEFAULT_RATE_ENABLED },
    items: [
      {
        id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
        name: "",
        price: "",
        qty: 1,
      },
    ],
    quickFinal: "",
  };

  function renderItemsTable(container, mode, displayDp) {
    const tbody = container.querySelector("#tax-levies-items-body");
    const priceHead = container.querySelector("#tax-levies-price-head");
    if (!tbody || !priceHead) return;

    priceHead.textContent = mode === "exclusive" ? "Price (excl taxes)" : "Price (incl taxes)";

    if (!state.items.length) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center muted">No items yet. Click "Add item".</td></tr>`;
      return;
    }

    const rowsHtml = state.items
      .map((item) => {
        const qty = safeNumber(item.qty);
        const price = safeNumber(item.price);
        const lineTotal = toPreciseNumber(price * qty);
        return `
          <tr data-item-id="${item.id}">
            <td><input type="text" class="tax-levies-input tax-item-name" placeholder="Item" value="${String(
              item.name || ""
            ).replace(/\"/g, "&quot;")}" /></td>
            <td><input type="number" class="tax-levies-input tax-item-price" min="0" step="0.0001" placeholder="0.0000" value="${item.price}" /></td>
            <td><input type="number" class="tax-levies-input tax-item-qty" min="0" step="1" placeholder="1" value="${qty}" /></td>
            <td class="numeric tax-item-line-total" style="font-variant-numeric: tabular-nums;">${formatGhc(
              lineTotal,
              displayDp
            )}</td>
            <td class="actions-cell"><button type="button" class="btn-ghost tax-item-remove" data-action="remove-item" aria-label="Remove">&times;</button></td>
          </tr>
        `;
      })
      .join("");

    tbody.innerHTML = rowsHtml;
  }

  function renderHistory(container) {
    const history = loadHistory();
    const list = container.querySelector("#tax-levies-history-list");
    const empty = container.querySelector("#tax-levies-history-empty");
    if (!list || !empty) return;

    if (!history.length) {
      list.innerHTML = "";
      empty.style.display = "block";
      return;
    }

    empty.style.display = "none";
    list.innerHTML = history
      .map((entry) => {
        const createdAt = entry.createdAt ? new Date(entry.createdAt) : new Date();
        const ts =
          typeof window.formatLocalTimestamp === "function"
            ? window.formatLocalTimestamp(createdAt)
            : createdAt.toLocaleString();
        const modeLabel = getModeLabel(entry.mode);
        const inputLabel = entry.mode === "exclusive" ? "Base" : "Total";
        const inputValue =
          entry.mode === "exclusive"
            ? safeNumber(entry.base)
            : safeNumber(entry.inputTotal ?? entry.inputGross ?? 0);
        return `
          <div class="tax-levies-history-item" data-history-id="${entry.id}">
            <div class="tax-levies-history-meta">${ts} | ${modeLabel}</div>
            <div class="tax-levies-history-summary">
              <span>${inputLabel}: ${formatGhc(inputValue, 2)}</span>
              <span>Taxes: ${formatGhc(entry.taxesTotal || 0, 2)}</span>
            </div>
            <div class="tax-levies-history-actions" data-export-hide="true">
              <button type="button" class="btn btn-secondary btn-small" data-action="view">View</button>
              <button type="button" class="btn btn-secondary btn-small" data-action="copy-whatsapp">WhatsApp</button>
              <button type="button" class="btn btn-secondary btn-small" data-action="copy-snapshot">Snapshot</button>
            </div>
          </div>
        `;
      })
      .join("");
  }

  function updateMainTotals(container) {
    const activeRates = getActiveRates();
    const result = computeItemsTotals(state.items, state.mode, activeRates);
    const dp = state.displayDp;
    result.rates = normalizeRates(state.rates);
    result.enabledRates = normalizeEnabledRates(state.enabledRates);
    const leviesEnabled =
      result.enabledRates.getfund || result.enabledRates.nhil || result.enabledRates.covid19;

    const baseLabelEl = container.querySelector("#tax-levies-base-label");
    const modeHint = container.querySelector("#tax-levies-mode-hint");
    if (baseLabelEl) {
      baseLabelEl.textContent = state.mode === "exclusive" ? "Base total" : "Implied base";
    }
    if (modeHint) {
      modeHint.textContent =
        state.mode === "exclusive"
          ? "Enter prices without taxes; I add levies + VAT."
          : "Feed me final prices; I reverse-engineer the base + taxes.";
    }

    const setText = (selector, text) => {
      const el = container.querySelector(selector);
      if (el) el.textContent = text;
    };

    // KPI tiles
    setText("#tax-levies-kpi-base", formatGhc(result.base, dp));
    setText("#tax-levies-kpi-levies", formatGhc(result.leviesTotal, dp));
    setText("#tax-levies-kpi-subtotal", formatGhc(result.subtotalAfterLevies, dp));
    setText("#tax-levies-kpi-vat", formatGhc(result.vat, dp));
    setText("#tax-levies-kpi-taxes", formatGhc(result.taxesTotal, dp));
    setText("#tax-levies-kpi-total", formatGhc(result.total, dp));
    const leviesTile = container
      .querySelector("#tax-levies-kpi-levies")
      ?.closest(".analytics-kpi");
    if (leviesTile) leviesTile.hidden = !leviesEnabled;
    const subtotalTile = container
      .querySelector("#tax-levies-kpi-subtotal")
      ?.closest(".analytics-kpi");
    if (subtotalTile) subtotalTile.hidden = !leviesEnabled;

    // Breakdown table
    const breakdownBody = container.querySelector("#tax-levies-breakdown-body");
    if (breakdownBody) {
      breakdownBody.innerHTML = buildBreakdownTableRows(
        state.mode,
        result,
        state.displayDp
      );
    }

    const adjustmentEl = container.querySelector("#tax-levies-adjustment-note");
    if (adjustmentEl) {
      if (Math.abs(result.roundingAdjustment || 0) >= 0.0001) {
        adjustmentEl.style.display = "block";
        adjustmentEl.textContent = `Rounding adjustment applied to ${
          result.roundingAppliedTo || "VAT"
        }: ${formatGhc(result.roundingAdjustment, 4)}`;
      } else {
        adjustmentEl.style.display = "none";
        adjustmentEl.textContent = "";
      }
    }

    return result;
  }

  function updateQuickReverse(container) {
    const dp = state.displayDp;
    const input = safeNumber(state.quickFinal);
    const activeRates = getActiveRates();
    const breakdown = calculateFromGross(input, activeRates);

    const setText = (selector, text) => {
      const el = container.querySelector(selector);
      if (el) el.textContent = text;
    };

    setText("#tax-levies-quick-base", formatGhc(breakdown.base, dp));
    setText("#tax-levies-quick-getfund", formatGhc(breakdown.getfund, dp));
    setText("#tax-levies-quick-nhil", formatGhc(breakdown.nhil, dp));
    setText("#tax-levies-quick-covid", formatGhc(breakdown.covid19, dp));
    setText("#tax-levies-quick-sub", formatGhc(breakdown.subtotalAfterLevies, dp));
    setText("#tax-levies-quick-vat", formatGhc(breakdown.vat, dp));
    setText("#tax-levies-quick-taxes", formatGhc(breakdown.taxesTotal, dp));
    setText("#tax-levies-quick-total", formatGhc(breakdown.total, dp));

    const adjustmentEl = container.querySelector("#tax-levies-quick-adjustment");
    if (adjustmentEl) {
      if (Math.abs(breakdown.roundingAdjustment || 0) >= 0.0001) {
        adjustmentEl.style.display = "block";
        adjustmentEl.textContent = `Rounding adjustment applied to ${
          breakdown.roundingAppliedTo || "VAT"
        }: ${formatGhc(breakdown.roundingAdjustment, 4)}`;
      } else {
        adjustmentEl.style.display = "none";
        adjustmentEl.textContent = "";
      }
    }

    return {
      mode: "quick",
      inputTotal: toPreciseNumber(input),
      rates: normalizeRates(state.rates),
      enabledRates: normalizeEnabledRates(state.enabledRates),
      ...breakdown,
    };
  }

  function addHistoryEntry(entry) {
    const history = loadHistory();
    const normalized = {
      id: entry.id || `${Date.now()}-${Math.random().toString(16).slice(2)}`,
      createdAt: entry.createdAt || new Date().toISOString(),
      mode: entry.mode,
      displayDp: sanitizeDisplayDp(entry.displayDp),
      items: Array.isArray(entry.items) ? entry.items : [],
      inputTotal: entry.inputTotal ?? entry.inputGross ?? 0,
      base: entry.base,
      getfund: entry.getfund,
      nhil: entry.nhil,
      covid19: entry.covid19,
      leviesTotal: entry.leviesTotal,
      subtotalAfterLevies: entry.subtotalAfterLevies,
      vat: entry.vat,
      taxesTotal: entry.taxesTotal,
      total: entry.total,
      roundingAdjustment: entry.roundingAdjustment || 0,
      roundingAppliedTo: entry.roundingAppliedTo || null,
      rates: normalizeRates(entry.rates || state.rates),
      enabledRates: normalizeEnabledRates(entry.enabledRates || state.enabledRates),
    };

    history.unshift(normalized);
    saveHistory(history.slice(0, MAX_HISTORY));
    return normalized;
  }

  function renderRates(container) {
    const el = container.querySelector("#tax-levies-rates-body");
    if (!el) return;
    const activeRates = getActiveRates();
    const rateRow = (label, key) => {
      const rate = state.rates[key];
      const enabled = state.enabledRates[key] !== false;
      return `
        <div class="tax-levies-rate-row">
          <div class="muted small">${label}</div>
          <div class="tax-levies-rate-controls">
            <input
              type="number"
              class="tax-levies-input tax-levies-rate-input"
              data-rate-input="${key}"
              min="0"
              step="0.1"
              value="${formatRateInputValue(rate)}"
              aria-label="${label} rate percentage">
            <span class="muted small">%</span>
            <label class="tax-levies-rate-toggle">
              <input type="checkbox" data-rate-toggle="${key}" ${enabled ? "checked" : ""}>
              <span>Apply</span>
            </label>
          </div>
        </div>
      `;
    };
    el.innerHTML = `
      <div class="tax-levies-rates-grid">
        ${rateRow("GETFund", "getfund")}
        ${rateRow("NHIL", "nhil")}
        ${rateRow("COVID", "covid19")}
        ${rateRow("VAT", "vat")}
      </div>
      <div class="muted small tax-levies-rate-note">
        Gross factor: <span id="tax-levies-gross-factor">${getGrossFactor(activeRates).toFixed(
          3
        )}</span> (levies + VAT on levies).
      </div>
    `;
  }

  function updateRateLabels(container, rates = getActiveRates()) {
    const map = [
      { key: "getfund", label: "GETFund" },
      { key: "nhil", label: "NHIL" },
      { key: "covid19", label: "COVID" },
      { key: "vat", label: "VAT" },
    ];
    map.forEach(({ key, label }) => {
      const el = container.querySelector(`[data-rate-label="${key}"]`);
      if (el) el.textContent = formatRateLabel(label, rates[key]);
    });
  }

  function updateRateRowVisibility(container, enabled = state.enabledRates) {
    const flags = normalizeEnabledRates(enabled);
    const leviesEnabled = flags.getfund || flags.nhil || flags.covid19;
    Object.entries(flags).forEach(([key, isEnabled]) => {
      container.querySelectorAll(`[data-rate-row="${key}"]`).forEach((row) => {
        row.hidden = !isEnabled;
      });
    });
    container.querySelectorAll("[data-levies-row]").forEach((row) => {
      row.hidden = !leviesEnabled;
    });
  }

  function updateRateSummary(container) {
    const activeRates = getActiveRates();
    const factorEl = container.querySelector("#tax-levies-gross-factor");
    if (factorEl) factorEl.textContent = getGrossFactor(activeRates).toFixed(3);
    updateRateLabels(container, activeRates);
    updateRateRowVisibility(container, state.enabledRates);
  }

  function bindRateControls(container) {
    const ratesBody = container.querySelector("#tax-levies-rates-body");
    if (!ratesBody) return;

    ratesBody.addEventListener("input", (e) => {
      const input = e.target?.closest("[data-rate-input]");
      if (!input) return;
      const key = input.dataset.rateInput;
      if (!key) return;
      state.rates[key] = Math.max(0, safeNumber(input.value)) / 100;
      updateMainTotals(container);
      updateQuickReverse(container);
      updateRateSummary(container);
    });

    ratesBody.addEventListener("change", (e) => {
      const toggle = e.target?.closest("[data-rate-toggle]");
      if (!toggle) return;
      const key = toggle.dataset.rateToggle;
      if (!key) return;
      state.enabledRates[key] = toggle.checked;
      updateMainTotals(container);
      updateQuickReverse(container);
      updateRateSummary(container);
    });
  }

  window.renderTaxLevies = function renderTaxLevies() {
    const container = document.getElementById("tax-levies-content");
    if (!container) return;

    container.innerHTML = `
      <div class="tax-levies-layout">
        <section class="settings-card tax-levies-card">
          <div class="section-header" style="margin-bottom: 14px;">
            <div>
              <p class="eyebrow">Sales</p>
              <h2 class="section-title">Tax Calculator</h2>
              <p class="muted small" id="tax-levies-mode-hint" style="margin-top: 6px;">
                Enter prices without taxes; I add levies + VAT.
              </p>
            </div>
            <div class="hero-actions" data-export-hide="true">
              <button type="button" class="btn btn-secondary btn-small" id="tax-levies-copy-whatsapp">Copy WhatsApp</button>
              <button type="button" class="btn btn-secondary btn-small" id="tax-levies-save-history">Save</button>
            </div>
          </div>

          <div class="tax-levies-controls" data-export-hide="true">
            <div class="tax-levies-mode">
              <button type="button" class="analytics-chip ${state.mode === "exclusive" ? "active" : ""}" data-tax-mode="exclusive">Tax-exclusive input</button>
              <button type="button" class="analytics-chip ${state.mode === "inclusive" ? "active" : ""}" data-tax-mode="inclusive">Tax-inclusive input</button>
            </div>
            <div class="tax-levies-precision">
              <label for="tax-levies-display-dp" class="muted small">Display decimals</label>
              <select id="tax-levies-display-dp">
                <option value="4" ${state.displayDp === 4 ? "selected" : ""}>4 decimals</option>
                <option value="3" ${state.displayDp === 3 ? "selected" : ""}>3 decimals</option>
                <option value="2" ${state.displayDp === 2 ? "selected" : ""}>2 decimals</option>
              </select>
            </div>
          </div>

          <div class="coa-table-wrapper modern-table tax-levies-items" style="padding: 16px; margin-top: 12px;">
            <table class="coa-table tax-levies-items-table">
              <thead>
                <tr>
                  <th style="width: 34%;">Item</th>
                  <th style="width: 20%;" id="tax-levies-price-head">Price (excl taxes)</th>
                  <th style="width: 12%;">Qty</th>
                  <th class="numeric" style="width: 24%;">Line total</th>
                  <th style="width: 10%; text-align:right;">&nbsp;</th>
                </tr>
              </thead>
              <tbody id="tax-levies-items-body"></tbody>
            </table>
            <div class="tax-levies-items-actions" data-export-hide="true">
              <button type="button" class="btn btn-secondary btn-small" id="tax-levies-add-item">Add item</button>
            </div>
          </div>

          <div class="analytics-kpi-grid tax-levies-kpis" style="margin-top: 12px;">
            <div class="analytics-kpi">
              <div class="kpi-label muted small" id="tax-levies-base-label">Base total</div>
              <div class="kpi-value" id="tax-levies-kpi-base">--</div>
              <div class="kpi-caption">Before levies & VAT</div>
            </div>
            <div class="analytics-kpi">
              <div class="kpi-label muted small">Levies total</div>
              <div class="kpi-value" id="tax-levies-kpi-levies">--</div>
              <div class="kpi-caption">GETFund + NHIL + COVID</div>
            </div>
            <div class="analytics-kpi">
              <div class="kpi-label muted small">Subtotal after levies</div>
              <div class="kpi-value" id="tax-levies-kpi-subtotal">--</div>
              <div class="kpi-caption">Base + levies</div>
            </div>
            <div class="analytics-kpi">
              <div class="kpi-label muted small">VAT</div>
              <div class="kpi-value" id="tax-levies-kpi-vat">--</div>
              <div class="kpi-caption">VAT on (base + levies)</div>
            </div>
            <div class="analytics-kpi">
              <div class="kpi-label muted small">Total taxes</div>
              <div class="kpi-value" id="tax-levies-kpi-taxes">--</div>
              <div class="kpi-caption">Levies + VAT</div>
            </div>
            <div class="analytics-kpi">
              <div class="kpi-label muted small">Final amount</div>
              <div class="kpi-value" id="tax-levies-kpi-total">--</div>
              <div class="kpi-caption">Customer paid</div>
            </div>
          </div>

          <div class="coa-table-wrapper modern-table" style="padding: 16px; margin-top: 12px;">
            <table class="coa-table tax-levies-breakdown-table">
              <tbody id="tax-levies-breakdown-body"></tbody>
            </table>
            <div class="muted small" id="tax-levies-adjustment-note" style="margin-top: 10px; display:none;"></div>
          </div>

          <details class="tax-levies-rates" style="margin-top: 12px;">
            <summary class="muted small">Rates</summary>
            <div id="tax-levies-rates-body" style="margin-top: 10px;"></div>
          </details>
        </section>

        <aside class="tax-levies-side">
          <section class="settings-card tax-levies-side-card">
            <div class="section-header" style="margin-bottom: 12px;">
              <div>
                <p class="eyebrow">Quick reverse</p>
                <h3 class="section-title" style="font-size: 18px;">Total -> Base + Taxes</h3>
                <p class="muted small" style="margin-top: 6px;">Feed me the final total; I unstack the levies + VAT.</p>
              </div>
              <div class="hero-actions" data-export-hide="true">
                <button type="button" class="btn btn-secondary btn-small" id="tax-levies-quick-copy">WhatsApp</button>
                <button type="button" class="btn btn-secondary btn-small" id="tax-levies-quick-save">Save</button>
              </div>
            </div>
            <div class="settings-form-row" style="margin-bottom: 10px;">
              <div class="settings-form-col" style="min-width: 0;">
                <label for="tax-levies-quick-final">Final total (incl taxes)</label>
                <input id="tax-levies-quick-final" type="number" min="0" step="0.0001" placeholder="e.g. 300.00" value="${state.quickFinal}">
              </div>
            </div>
            <div class="coa-table-wrapper modern-table" style="padding: 16px;">
              <table class="coa-table">
                <tbody>
                  <tr><td>Implied base</td><td class="numeric" id="tax-levies-quick-base">--</td></tr>
                  <tr data-rate-row="getfund"><td data-rate-label="getfund">GETFund</td><td class="numeric" id="tax-levies-quick-getfund">--</td></tr>
                  <tr data-rate-row="nhil"><td data-rate-label="nhil">NHIL</td><td class="numeric" id="tax-levies-quick-nhil">--</td></tr>
                  <tr data-rate-row="covid19"><td data-rate-label="covid19">COVID</td><td class="numeric" id="tax-levies-quick-covid">--</td></tr>
                  <tr data-levies-row="subtotal"><td>Subtotal after levies</td><td class="numeric" id="tax-levies-quick-sub">--</td></tr>
                  <tr data-rate-row="vat"><td data-rate-label="vat">VAT</td><td class="numeric" id="tax-levies-quick-vat">--</td></tr>
                  <tr><td style="font-weight:700;">Total taxes</td><td class="numeric" style="font-weight:700;" id="tax-levies-quick-taxes">--</td></tr>
                  <tr style="border-top:2px solid var(--border); font-weight:900;"><td>Recomputed total</td><td class="numeric" id="tax-levies-quick-total">--</td></tr>
                </tbody>
              </table>
              <div class="muted small" id="tax-levies-quick-adjustment" style="margin-top: 10px; display:none;"></div>
            </div>
          </section>

          <section class="settings-card tax-levies-side-card">
            <div class="section-header" style="margin-bottom: 12px;">
              <div>
                <p class="eyebrow">History</p>
                <h3 class="section-title" style="font-size: 18px;">Recent calculations</h3>
                <p class="muted small" style="margin-top: 6px;">I keep your last ${MAX_HISTORY} calculations here.</p>
              </div>
              <div class="hero-actions" data-export-hide="true">
                <button type="button" class="btn btn-secondary btn-small" id="tax-levies-clear-history">Clear</button>
              </div>
            </div>
            <div id="tax-levies-history-empty" class="muted small" style="display:none;">No history yet. Save a calculation to see it here.</div>
            <div id="tax-levies-history-list" class="tax-levies-history-list"></div>
          </section>
        </aside>
      </div>
    `;

    // Improve the default select styling via existing pattern
    container.querySelector("#tax-levies-display-dp")?.classList.add("coa-filter-select");

    renderRates(container);
    bindRateControls(container);
    updateRateSummary(container);
    renderItemsTable(container, state.mode, state.displayDp);

    updateMainTotals(container);
    updateQuickReverse(container);
    renderHistory(container);

    // Mode toggle
    container.querySelectorAll("[data-tax-mode]").forEach((btn) => {
      btn.addEventListener("click", () => {
        state.mode = btn.dataset.taxMode;
        window.renderTaxLevies();
      });
    });

    // Display decimals toggle
    container.querySelector("#tax-levies-display-dp")?.addEventListener("change", (e) => {
      state.displayDp = sanitizeDisplayDp(e.target.value);
      updateMainTotals(container);
      updateQuickReverse(container);
      renderItemsTable(container, state.mode, state.displayDp);
    });

    // Items edit + remove (event delegation)
    const itemsBody = container.querySelector("#tax-levies-items-body");
    itemsBody?.addEventListener("input", (e) => {
      const row = e.target?.closest("tr[data-item-id]");
      if (!row) return;
      const id = row.dataset.itemId;
      const item = state.items.find((it) => it.id === id);
      if (!item) return;

      if (e.target.classList.contains("tax-item-name")) {
        item.name = e.target.value;
      } else if (e.target.classList.contains("tax-item-price")) {
        item.price = e.target.value;
      } else if (e.target.classList.contains("tax-item-qty")) {
        item.qty = e.target.value;
      }

      // Update just this line total cell (avoid full re-render while typing).
      const qty = safeNumber(item.qty);
      const price = safeNumber(item.price);
      const lineTotal = toPreciseNumber(price * qty);
      row.querySelector(".tax-item-line-total").textContent = formatGhc(
        lineTotal,
        state.displayDp
      );
      updateMainTotals(container);
    });

    itemsBody?.addEventListener("click", (e) => {
      const action = e.target?.dataset?.action;
      if (action !== "remove-item") return;
      const row = e.target.closest("tr[data-item-id]");
      if (!row) return;
      const id = row.dataset.itemId;
      state.items = state.items.filter((it) => it.id !== id);
      renderItemsTable(container, state.mode, state.displayDp);
      updateMainTotals(container);
    });

    // Add item
    container.querySelector("#tax-levies-add-item")?.addEventListener("click", () => {
      state.items.push({
        id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
        name: "",
        price: "",
        qty: 1,
      });
      renderItemsTable(container, state.mode, state.displayDp);
      updateMainTotals(container);
    });

    // Copy WhatsApp for main calc
    container.querySelector("#tax-levies-copy-whatsapp")?.addEventListener("click", () => {
      const current = updateMainTotals(container);
      copyText(buildWhatsappSummary({ ...current, displayDp: state.displayDp }));
      addHistoryEntry({
        mode: state.mode,
        displayDp: state.displayDp,
        createdAt: new Date().toISOString(),
        items: state.items.map((it) => ({ ...it })),
        inputTotal: current.inputTotal,
        ...current,
      });
      renderHistory(container);
    });

    // Save main calc
    container.querySelector("#tax-levies-save-history")?.addEventListener("click", () => {
      const current = updateMainTotals(container);
      if (!current || Math.abs(current.inputTotal || 0) < 0.0001) {
        alert("Add at least one item/amount before saving.");
        return;
      }
      addHistoryEntry({
        mode: state.mode,
        displayDp: state.displayDp,
        createdAt: new Date().toISOString(),
        items: state.items.map((it) => ({ ...it })),
        inputTotal: current.inputTotal,
        ...current,
      });
      renderHistory(container);
    });

    // Quick reverse input
    container.querySelector("#tax-levies-quick-final")?.addEventListener("input", (e) => {
      state.quickFinal = e.target.value;
      updateQuickReverse(container);
    });

    // Quick reverse copy/save
    container.querySelector("#tax-levies-quick-copy")?.addEventListener("click", () => {
      const q = updateQuickReverse(container);
      copyText(buildWhatsappSummary({ ...q, displayDp: state.displayDp }));
      addHistoryEntry({ ...q, displayDp: state.displayDp, createdAt: new Date().toISOString() });
      renderHistory(container);
    });
    container.querySelector("#tax-levies-quick-save")?.addEventListener("click", () => {
      const q = updateQuickReverse(container);
      if (!q || Math.abs(q.inputTotal || 0) < 0.0001) {
        alert("Enter a total amount before saving.");
        return;
      }
      addHistoryEntry({ ...q, displayDp: state.displayDp, createdAt: new Date().toISOString() });
      renderHistory(container);
    });

    // Clear history
    container.querySelector("#tax-levies-clear-history")?.addEventListener("click", async () => {
      const ok = window.showCustomConfirm
        ? await window.showCustomConfirm("Clear tax/levies history?", "Clear history")
        : confirm("Clear tax/levies history?");
      if (!ok) return;
      saveHistory([]);
      renderHistory(container);
    });

    // History actions (event delegation)
    const historyList = container.querySelector("#tax-levies-history-list");
    historyList?.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;
      const action = btn.dataset.action;
      const item = btn.closest(".tax-levies-history-item");
      const id = item?.dataset?.historyId;
      if (!id) return;
      const history = loadHistory();
      const entry = history.find((h) => String(h.id) === String(id));
      if (!entry) return;

      if (action === "view") {
        openHistoryModal(entry);
      } else if (action === "copy-whatsapp") {
        copyText(buildWhatsappSummary(entry));
      } else if (action === "copy-snapshot") {
        openHistoryModal(entry, { autoSnapshot: true });
      }
    });
  };
})();


      window.renderTaxLevies && window.renderTaxLevies();
    </script>
  </body>
</html>
